"use strict";function SortedSet(t,e,n,i){return this instanceof SortedSet?(this.contentEquals=e||Object.equals,this.contentCompare=n||Object.compare,this.getDefault=i||Function.noop,this.root=null,this.length=0,this.addEach(t),void 0):new SortedSet(t,e,n,i)}function Node(t){this.value=t,this.left=null,this.right=null,this.length=1}function Iterator(t,e,n){if(this.set=t,this.prev=null,this.end=n,e){var i=this.set.findLeastGreaterThanOrEqual(e);i&&(this.set.splay(i.value),this.prev=i.getPrevious())}}module.exports=SortedSet;var Shim=require("./shim"),GenericCollection=require("./generic-collection"),GenericSet=require("./generic-set"),PropertyChanges=require("./listen/property-changes"),RangeChanges=require("./listen/range-changes"),TreeLog=require("./tree-log");Object.addEach(SortedSet.prototype,GenericCollection.prototype),Object.addEach(SortedSet.prototype,GenericSet.prototype),Object.addEach(SortedSet.prototype,PropertyChanges.prototype),Object.addEach(SortedSet.prototype,RangeChanges.prototype),SortedSet.prototype.constructClone=function(t){return new this.constructor(t,this.contentEquals,this.contentCompare,this.getDefault)},SortedSet.prototype.has=function(t){return this.root?(this.splay(t),this.contentEquals(t,this.root.value)):!1},SortedSet.prototype.get=function(t){return this.root&&(this.splay(t),this.contentEquals(t,this.root.value))?this.root.value:this.getDefault(t)},SortedSet.prototype.add=function(t){var e=new this.Node(t);if(!this.root)return this.dispatchesRangeChanges&&this.dispatchBeforeRangeChange([t],[],0),this.root=e,this.length++,this.dispatchesRangeChanges&&this.dispatchRangeChange([t],[],0),!0;if(this.splay(t),!this.contentEquals(t,this.root.value)){var n=this.contentCompare(t,this.root.value);if(0===n)throw Error("SortedSet cannot contain incomparable but inequal values: "+t+" and "+this.root.value);return this.dispatchesRangeChanges&&this.dispatchBeforeRangeChange([t],[],this.root.index),0>n?(e.right=this.root,e.left=this.root.left,this.root.left=null,this.root.touch()):(e.left=this.root,e.right=this.root.right,this.root.right=null,this.root.touch()),e.touch(),this.root=e,this.length++,this.dispatchesRangeChanges&&this.dispatchRangeChange([t],[],this.root.index),!0}return!1},SortedSet.prototype["delete"]=function(t){if(this.root&&(this.splay(t),this.contentEquals(t,this.root.value))){var e=this.root.index;if(this.dispatchesRangeChanges&&this.dispatchBeforeRangeChange([],[t],e),this.root.left){var n=this.root.right;this.root=this.root.left,this.splay(t),this.root.right=n}else this.root=this.root.right;return this.length--,this.root&&this.root.touch(),this.dispatchesRangeChanges&&this.dispatchRangeChange([],[t],e),!0}return!1},SortedSet.prototype.indexOf=function(t){return this.root&&(this.splay(t),this.contentEquals(t,this.root.value))?this.root.index:-1},SortedSet.prototype.find=function(t){return this.root&&(this.splay(t),this.contentEquals(t,this.root.value))?this.root:void 0},SortedSet.prototype.findGreatest=function(t){if(this.root){for(t=t||this.root;t.right;)t=t.right;return t}},SortedSet.prototype.findLeast=function(t){if(this.root){for(t=t||this.root;t.left;)t=t.left;return t}},SortedSet.prototype.findGreatestLessThanOrEqual=function(t){return this.root?(this.splay(t),this.root):void 0},SortedSet.prototype.findGreatestLessThan=function(t){return this.root?(this.splay(t),this.root.getPrevious()):void 0},SortedSet.prototype.findLeastGreaterThanOrEqual=function(t){if(this.root){this.splay(t);var e=this.contentCompare(t,this.root.value);return 0===e?this.root:this.root.getNext()}},SortedSet.prototype.findLeastGreaterThan=function(t){return this.root?(this.splay(t),this.contentCompare(t,this.root.value),this.root.getNext()):void 0},SortedSet.prototype.pop=function(){if(this.root){var t=this.findGreatest();return this["delete"](t.value),t.value}},SortedSet.prototype.shift=function(){if(this.root){var t=this.findLeast();return this["delete"](t.value),t.value}},SortedSet.prototype.push=function(){this.addEach(arguments)},SortedSet.prototype.unshift=function(){this.addEach(arguments)},SortedSet.prototype.slice=function(t,e){t=t||0,e=e||this.length,0>t&&(t+=this.length),0>e&&(e+=this.length);var n=[];if(this.root)for(this.splayIndex(t);e>this.root.index&&(n.push(this.root.value),this.root.right);)this.splay(this.root.getNext().value);return n},SortedSet.prototype.splice=function(t,e){return this.swap(t,e,Array.prototype.slice.call(arguments,2))},SortedSet.prototype.swap=function(t,e,n){if(void 0===t&&void 0===e)return[];t=t||0,0>t&&(t+=this.length),void 0===e&&(e=1/0);var i=[];if(this.root){this.splayIndex(t);for(var a=0;e>a;a++){i.push(this.root.value);var r=this.root.getNext();if(this["delete"](this.root.value),!r)break;this.splay(r.value)}}return this.addEach(n),i},SortedSet.prototype.splay=function(t){var e,n,i,a,r,s;if(this.root){for(e=n=i=new this.Node,s=new this.Node,r=this.root;;){var o=this.contentCompare(t,r.value);if(0>o){if(!r.left)break;if(0>this.contentCompare(t,r.left.value)&&(a=r.left,r.left=a.right,r.touch(),a.right=r,a.touch(),r=a,!r.left))break;a=new Node,a.right=r,a.left=s.left,s.left=a,i.left=r,i.touch(),i=r,r=r.left}else{if(!(o>0))break;if(!r.right)break;if(this.contentCompare(t,r.right.value)>0&&(a=r.right,r.right=a.left,r.touch(),a.left=r,a.touch(),r=a,!r.right))break;a=new Node,a.left=r,a.right=s.right,s.right=a,n.right=r,n.touch(),n=r,r=r.right}}for(n.right=r.left,n.touch(),i.left=r.right,i.touch(),r.left=e.right,r.right=e.left;s.left;)s.left.right.touch(),s.left=s.left.left;for(;s.right;)s.right.left.touch(),s.right=s.right.right;r.touch(),this.root=r}},SortedSet.prototype.splayIndex=function(t){if(this.root){for(var e=this.root,n=this.root.index;n!==t;)if(n>t&&e.left)e=e.left,n-=1+(e.right?e.right.length:0);else{if(!(t>n&&e.right))break;e=e.right,n+=1+(e.left?e.left.length:0)}return this.splay(e.value),this.root.index===t}return!1},SortedSet.prototype.reduce=function(t,e,n){return this.root&&(e=this.root.reduce(t,e,0,n,this)),e},SortedSet.prototype.reduceRight=function(t,e,n){return this.root&&(e=this.root.reduceRight(t,e,this.length-1,n,this)),e},SortedSet.prototype.min=function(t){var e=this.findLeast(t);return e?e.value:void 0},SortedSet.prototype.max=function(t){var e=this.findGreatest(t);return e?e.value:void 0},SortedSet.prototype.one=function(){return this.root?this.root.value:void 0},SortedSet.prototype.clear=function(){var t;this.dispatchesRangeChanges&&(t=this.toArray(),this.dispatchBeforeRangeChange([],t,0)),this.root=null,this.length=0,this.dispatchesRangeChanges&&this.dispatchRangeChange([],t,0)},SortedSet.prototype.iterate=function(t,e){return new this.Iterator(this,t,e)},SortedSet.prototype.Iterator=Iterator,SortedSet.prototype.summary=function(){return this.root?this.root.summary():"()"},SortedSet.prototype.log=function(t,e,n,i){t=t||TreeLog.unicodeRound,e=e||this.logNode,n||(n=console.log,i=console),n=n.bind(i),this.root&&this.root.log(t,e,n,n)},SortedSet.prototype.logNode=function(t,e){e(" "+t.value)},SortedSet.logCharsets=TreeLog,SortedSet.prototype.Node=Node,Node.prototype.reduce=function(t,e,n,i,a,r){if(r=r||0,this.left){var s=this.left.length;e=this.left.reduce(t,e,n,i,a,r+1),n+=s}return e=t.call(i,e,this.value,n,a,this,r),n+=1,this.right&&(e=this.right.reduce(t,e,n,i,a,r+1)),e},Node.prototype.reduceRight=function(t,e,n,i,a,r){return r=r||0,this.right&&(e=this.right.reduce(t,e,n,i,a,r+1),n-=this.right.length),e=t.call(i,e,this.value,this.value,a,this,r),n-=1,this.left&&(e=this.left.reduce(t,e,n,i,a,r+1)),e},Node.prototype.touch=function(){this.length=1+(this.left?this.left.length:0)+(this.right?this.right.length:0),this.index=this.left?this.left.length:0},Node.prototype.checkIntegrity=function(){var t=1;if(t+=this.left?this.left.checkIntegrity():0,t+=this.right?this.right.checkIntegrity():0,this.length!==t)throw Error("Integrity check failed: "+this.summary());return t},Node.prototype.getNext=function(){var t=this;if(t.right){for(t=t.right;t.left;)t=t.left;return t}},Node.prototype.getPrevious=function(){var t=this;if(t.left){for(t=t.left;t.right;)t=t.right;return t}},Node.prototype.summary=function(){var t=this.value||"-";return t+=" <"+this.length,this.left||this.right?"("+t+" "+(this.left?this.left.summary():"()")+", "+(this.right?this.right.summary():"()")+")":"("+t+")"},Node.prototype.log=function(t,e,n,i){var a,r=this;a=this.left&&this.right?t.intersection:this.left?t.branchUp:this.right?t.branchDown:t.through;var s;this.left&&this.left.log(t,e,function(e){s?i(t.strafe+" "+e):(s=!0,i(t.fromBelow+t.through+e))},function(t){i("  "+t)});var o;e(this,function(e){o?n((r.right?t.strafe:" ")+e):(o=!0,n(a+e))},function(e){i((r.left?t.strafe:" ")+e)});var l;this.right&&this.right.log(t,e,function(e){l?n("  "+e):(l=!0,n(t.fromAbove+t.through+e))},function(e){n(t.strafe+" "+e)})},Iterator.prototype.next=function(){var t;if(t=this.prev?this.set.findLeastGreaterThan(this.prev.value):this.set.findLeast(),!t)throw StopIteration;if(void 0!==this.end&&this.set.contentCompare(t.value,this.end)>=0)throw StopIteration;return this.prev=t,t.value};