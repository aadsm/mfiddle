(function(t){function e(t,e){this.builder=t,this.labeler=e,this._objectsSerialization=Object.create(null)}function n(t){var n=e.prototype.getCustomObjectTypeOf;return function(e){return t(e)||n(e)}}require("collections/shim-object"),Object.defineProperties(e.prototype,{builder:{value:null,writable:!0},labeler:{value:null,writable:!0},getTypeOf:{value:function(t){return this.isCustomObject(t)?"CustomObject":void 0}},getCustomObjectTypeOf:{value:function(){},writable:!0},isCustomObject:{value:function(t){var e=this.getCustomObjectTypeOf(t);return"string"==typeof e}},_objectsSerialization:{value:null,writable:!0},setObjectSerialization:{value:function(t,e){this._objectsSerialization[Object.hash(t)]=e}},getObjectSerialization:{value:function(t){return this._objectsSerialization[Object.hash(t)]}},isObjectSerialized:{value:function(t){return Object.hash(t)in this._objectsSerialization}},enterObject:{value:function(t,e){var n=this.builder.createObjectLiteral();this.setObjectSerialization(e,n),this.builder.push(n)}},exitObject:{value:function(t,e,n){this.storeValue(this.builder.pop(),e,n)}},visitObject:{value:function(t,e,n){var i=this.labeler.getObjectLabel(e),a=this.builder.createObjectReference(i);this.getObjectSerialization(e).setLabel(i),this.builder.top.setProperty(n,a)}},enterArray:{value:function(t,e){var n=this.builder.createArray();this.setObjectSerialization(e,n),this.builder.push(n)}},exitArray:{value:function(t,e,n){this.storeValue(this.builder.pop(),e,n)}},visitArray:{value:function(t,e,n){var i=this.labeler.getObjectLabel(e),a=this.builder.createObjectReference(i);this.getObjectSerialization(e).setLabel(i),this.builder.top.setProperty(n,a)}},visitRegExp:{value:function(t,e,n){this.storeValue(this.builder.createRegExp(e),e,n)}},visitString:{value:function(t,e,n){this.storeValue(this.builder.createString(e),e,n)}},visitNumber:{value:function(t,e,n){this.storeValue(this.builder.createNumber(e),e,n)}},visitBoolean:{value:function(t,e,n){this.storeValue(this.builder.createBoolean(e),e,n)}},visitNull:{value:function(t,e){this.storeValue(this.builder.createNull(),null,e)}},visitCustomObject:{value:function(t,e,n){var a=this.getCustomObjectTypeOf(e),r=i["visit"+a];if(a)return r.call(global,t,this,e,n);throw Error("Object's type is unknown: "+e)}},storeValue:{value:function(t,e,n){n===void 0?t.setLabel(this.labeler.getObjectLabel(e)):this.builder.top.setProperty(n,t)}}});var i=Object.create(null);e.addCustomObjectVisitor=function(t){for(var e in t)if("getTypeOf"!==e&&"function"==typeof t[e]&&/^visit/.test(e)){if(void 0!==i[e])return Error("Visitor '"+e+"' is already registered.");i[e]=t[e].bind(t)}this.prototype.getCustomObjectTypeOf=n(t.getTypeOf)},e.resetCustomObjectVisitors=function(){i=Object.create(null),this.prototype.getCustomObjectTypeOf=function(){}},t.Visitor=e})(exports);