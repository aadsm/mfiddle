var Bindings=require("montage/core/bindings").Bindings,RangeController=require("montage/core/range-controller").RangeController,NativeControl=require("ui/native-control").NativeControl,PressComposer=require("montage/composer/press-composer").PressComposer,Select=exports.Select=NativeControl.specialize({_fromInput:{value:null},_synching:{value:null},_selectedIndexes:{value:null},selectedIndexes:{get:function(){return this._selectedIndexes},set:function(t){for(var e=this.content,n=[],i=0,a=t.length;a>i;i++)n.push(e[t[i]][this.valuePropertyPath||"value"]);1>=t.length?this.value=n[0]:this.values=n}},constructor:{value:function Select(){this.super(),this._selectedIndexes=[],this._selectedIndexes.addRangeChangeListener(this,"selectedIndexes")}},handleSelectedIndexesRangeChange:{value:function(){this.needsDraw===!1&&(this.needsDraw=this._synching||!this._fromInput)}},_setContentControllerSelectedIndexes:{value:function(t){for(var e,n=this.content,i=this._contentController.selection,a=0,r=n.length;r>a;a++)t.indexOf(a)>=0?-1===i.indexOf(n[a])&&i.push(n[a]):(e=i.indexOf(n[a]),e>=0&&i.splice(e,1))}},_content:{value:null,enumerable:!1},content:{set:function(t){if(this._content=t,!this.contentController){var e=new RangeController;e.content=t,this.contentController=e}this.needsDraw=!0},get:function(){return this._content}},valuePropertyPath:{value:null},textPropertyPath:{value:null},_contentController:{value:null},contentController:{get:function(){return this._contentController},set:function(t){this._contentController!==t&&(this._contentController=t,t.multiSelect=this.multiple,Bindings.defineBindings(this,{content:{"<-":"_contentController.organizedContent"},_selection:{"<-":"_contentController.selection"},"_selectedIndexes.rangeContent()":{"<-":"content.enumerate().filter{$_selection.has(.1)}.map{.0}"}}))}},_getSelectedValuesFromIndexes:{value:function(){var t,e,n=this._selectedIndexes,i=this._content,a=n.length;if(a>0){t=[],e=this.valuePropertyPath||"value";for(var r=0;a>r;r++)i[n[r]][e]&&t.push(i[n[r]][e])}return t}},_synchValues:{value:function(){this._synching||(this._synching=!0,this.values=this._getSelectedValuesFromIndexes(),this.value=this.values&&this.values.length>0?this.values[0]:null,this._synching=!1)}},_values:{value:null},values:{get:function(){return this._values},set:function(t){var e=this.content;if(t&&e&&(this._values=t,!this._synching)){for(var n,i=[],a=0,r=this._values.length;r>a;a++)n=this._indexOf(this._values[a]),n>=0&&i.push(n);this._synching=!0,this._setContentControllerSelectedIndexes(i),this._synching=!1}}},_value:{value:null},value:{get:function(){return this._value},set:function(t){this._value=t,this._synching||(this.values=null==t?[]:[t])}},blur:{value:function(){this._element.blur()}},focus:{value:function(){this._element.focus()}},_addOptionsFromMarkup:{value:function(){var t=this.element,e=t.querySelectorAll("option");if(!this.contentController){var n=new RangeController,i=[],a=[];if(e&&e.length>0){for(var r,s=0,o=e.length;o>s;s++){r=e[s].getAttribute("selected");var l={value:e[s].value,text:e[s].textContent};r&&i.push(l),a.push(l)}0===i.length&&o>0&&i.push(a[0]),this._fromInput=!0,this.contentController=n,n.content=a,n.selection=i}}}},deserializedFromTemplate:{value:function(){this._addOptionsFromMarkup()}},_removeAll:{value:function(t){for(;t.firstChild;)t.removeChild(t.firstChild)}},_refreshOptions:{value:function(){var t,e,n,i,a=this.content||[],r=a.length;for(t=0;r>t;t++)e=document.createElement("option"),"string"==typeof a[t]?n=i=a[t]:(n=a[t][this.textPropertyPath||"text"],i=a[t][this.valuePropertyPath||"value"]),e.value=i,e.textContent=n||i,this._selectedIndexes&&this._selectedIndexes.length>0&&this._selectedIndexes.indexOf(t)>=0&&e.setAttribute("selected","true"),this.element.appendChild(e);0===this._selectedIndexes.length&&this.element.selectedIndex>=0&&(this._selectedIndexes[0]=this.element.selectedIndex)}},enterDocument:{value:function(t){t&&(this.element.addEventListener("focus",this),this.element.addEventListener("change",this))}},prepareForActivationEvents:{value:function(){var t=new PressComposer;this.addComposer(t)}},draw:{enumerable:!1,value:function(){var t=this.element;this._fromInput=!1,this._synching=!1,this._removeAll(t),this._refreshOptions(),this.super()}},didDraw:{value:function(){this._synchValues()}},_indexOf:{value:function(t){var e,n,i=this.content||[],a=i.length;for(e=0;a>e;e++)if(n="string"==typeof i[e]?i[e]:i[e][this.valuePropertyPath||"value"],n&&n===t)return e;return-1}},_getSelectedOptions:{value:function(t){var e,n=t.querySelectorAll("option"),i=n.length,a=[];for(e=0;i>e;e++)n[e].selected&&a.push(n[e]);return a}},_getSelectedOptionsIndexes:{value:function(t){var e,n=t.querySelectorAll("option"),i=n.length,a=[];for(e=0;i>e;e++)n[e].selected&&a.push(e);return a}},handleChange:{value:function(){var t=this._getSelectedOptionsIndexes(this.element);t.length>0&&(this._fromInput=!0,this._synching=!1,this._setContentControllerSelectedIndexes(t),this._synchValues())}}});Select.addAttributes({autofocus:{dataType:"boolean"},disabled:{dataType:"boolean"},form:null,multiple:{dataType:"boolean"},name:null,required:{dataType:"boolean"},size:{dataType:"number",value:"1"}});